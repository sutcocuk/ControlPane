name: Build Splunk Add-on

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      VERSION: 1.0.1  # You can dynamically set this if you want

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install UCC Generator
        run: |
          python -m pip install --upgrade pip
          pip install splunk-add-on-ucc-framework

      - name: Verify app.manifest exists
        run: |
          test -f app.manifest || (echo "app.manifest missing" && exit 1)

      - name: Build add-on
        run: |
          ucc-gen build --source .

      - name: Copy manifest into build output
        run: |
          cp app.manifest output/ControlPane/app.manifest

      - name: Package add-on
        run: |
          mkdir -p packages
          mkdir -p app-dir
          ucc-gen package --path output/ControlPane -o app-dir/
          # Move the .spl file to packages/ preserving version
          mv app-dir/ControlPane/*.spl packages/

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: spl-packages
          path: packages/*.spl
